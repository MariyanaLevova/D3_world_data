<!DOCTYPE html>
<html lang = "en" class="tas-com">
<head>
	<meta charset="utf-8">
	<title>Assignment 2 - Channelling Hans</title>
    
    <!-- D3 CDN -->
	<script src='https://d3js.org/d3.v4.min.js'></script>
    
    <!-- External stylesheet -->
    <link rel="stylesheet" type="text/css" href="style.css">
    
    <!-- Bootstrap CDN -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    
    <!-- Main JS file -->
    <!--<script src="main.js"></script>-->
    
    <!-- Select2 Menu -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.full.js"></script>
</head>
<body>
    
    <div class="row">
	   <div class="col-sm-10 col-main box-left">
           
            <div class="box">
                <div id="box-one"></div>
            </div>
           
        </div>
        
        <div class="col-sm-2 col-main">
            
            <div id="box-right">
                
            </div>
        
        </div>
    </div>
    
    <script>
    
        d3.csv("GCI_CompleteData2.csv", function(error, data){
            
            // Define margins
			var margin = {top: 10, right: 10, bottom: 25, left: 50};
			
			//Width and height
			var outer_width = 500;
			var outer_height = 300;
			var svg_width = outer_width - margin.left - margin.right;
			var svg_height = outer_height - margin.top - margin.bottom;

			// The year to display
			display_year = 2007;
            
            // The global data set object
            var dataset;
            
            // Store column names in array so can reference below
            var columnNames = [
                'Institutions',
                'Infrastructure',
                'Macroeconomic Environment',
                'Health and Primary Education',
                'Higher Education and Training',
                'Goods Market Efficiency',
                'Labor Market Efficiency',
                'Financial Market Development',
                'Technological Readiness',
                'Market Size',
                'Business Sophistication',
                'Innovation'
            ];
			
			// define a function that filters data by year
			function yearFilter(value){
				return (value.Year == display_year)
			}
            
            // define a function that filters data by year
            // Just for one country at the moment
			function countryFilter(value){
				return (value.Country == 'Ireland')
			}
			
			//Create SVG element as a group with the margins transform applied to it
			var svg = d3.select("#box-one")
						.append("svg")
						.attr("width", svg_width + margin.left + margin.right)
						.attr("height", svg_height + margin.top + margin.bottom)
						.append("g")
						.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
			
			// Create a scale to scale market share values nicely for bar heights
			var yScale = d3.scaleLinear()
				                     .domain([0, 7])
				                     .range([svg_height, 0]);
	
			// Create a scale object to nicely take care of positioning bars along the horizontal axis
			// We don't set the domain yet as data isn't loaded
			var xScale = d3.scaleBand()
							.range([0, svg_width], 0.5)
							.paddingInner(0.05)
							.paddingOuter(0.05);
						
			//Define Y axis
			var yAxis = d3.axisLeft()
							  .scale(yScale)
							  .ticks(5);
			
			// Create an x-axis connected to the x scale
			var xAxis = d3.axisBottom()
						 .scale(xScale)
                         .tickFormat([null]);
						  
			// Call the y axis
			svg.append("g")
				.attr("class", "axis")
				.attr("id", "y-axis")
				.call(yAxis);
					
			// All but call the x-axis
			svg.append("g")
				.attr("class", "axis")
				.attr("id", "x-axis")
				.attr("transform", "translate(0," + svg_height + ")");
					
			// Define a fucntion to draw a simple bar chart
			function generateVis() {
                
                
                // Key Part
                // --------------------------------------------------------------------------------
                
                // Filter the data as before
                var filtered_datset = dataset.filter(yearFilter);
                var country_filtered = filtered_datset.filter(countryFilter);

                // Loop through every element in the filtered dataset and add to array dataHold
                // Doing this because otherwise the D3 functions only run once.
                // The arrayHold will hold 12 objects each composed of one of the columns from the CSV
                // The D3 functions will use arrayHold
                // They will now iterate 12 times - one iteration for each column.
                dataHold = []
                for (i = 0; i < columnNames.length; i++) {
                    var temp = columnNames[i];
                    // Create object
                    var tempObj = {};
                    // Add column to object with key = 'Column' and value = Innovation etc.
                    // The key value ('Column') is the same for all CSV columns
                    // It means in the D3 functions below I can just say d3.Column to call it.
                    tempObj["Column"] = country_filtered[0][temp];
                    // Append object to dataHold to create new row in array
                    dataHold.push(tempObj);
                }
                //console.log(dataHold);

                // Update the domain of the x scale
                xScale.domain(dataHold.map(function(d, i) { return d.Column; }));
                // Call the x-axis
                svg.select("#x-axis").call(xAxis);
                
                // --------------------------------------------------------------------------------
                
			 	/******** PERFORM DATA JOIN ************/
			  	// Join new data with old elements, if any.
			  	var bars = 	svg.selectAll("rect")
				   /*.data(dataHold, function key(d) {
											return d.Country;
										});*/
                    .data(dataHold);
			
			 	/******** HANDLE UPDATE SELECTION ************/
			  	// Update the display of existing elelemnts to mathc new data
			  	bars
					.transition()
					.duration(500)
					.ease(d3.easeCubic)
					.attr("x", function(d) {
				   		return xScale(+d.Column);
				   })
				   .attr("y", function(d) {
				   		return yScale(+d.Column) ;
				   })
				   .attr("width", xScale.bandwidth())
				   .attr("height", function(d) {
				   		return svg_height - yScale(+d.Column);
				   })
				   .style("fill", "Green");
					   
			
				/******** HANDLE ENTER SELECTION ************/
			  	// Create new elements in the dataset
			  	bars.enter()
				   .append("rect")
					.transition()
					.duration(500)
					.ease(d3.easeCubic)
				   .attr("x", function(d, i) {
				   		return xScale(+d.Column);
				   })
				   .attr("y", function(d, i) {
				   		return yScale(+d.Column) ;
				   })
				   .attr("width", xScale.bandwidth())
				   .attr("height", function(d, i) {
				   		return svg_height - yScale(+d.Column);
				   })
                    // Could maybe use this to show a comparison between two countries?
				   .style("fill", function(d, i) { if (i % 2 == 0) { return "Blue"; } else { return "Red"; } });
			
				/******** HANDLE EXIT SELECTION ************/
				// Remove bars that not longer have a matching data eleement
				bars.exit()
                    .style("fill", "Red")
                    .transition()
                    .duration(500)
                    .attr("r", 0)
                    .remove();
  
			}
				
				// handle any data loading errors
				if(error){
					console.log("Something went wrong");
					console.log(error);
				}else{
					console.log("Data Loaded");
                    
                    data.forEach(function(d){ 
                        d['GDP'] = +d['GDP'];
                        d['Global_Competitiveness_Index'] = +d['Global_Competitiveness_Index']; 
                        d['Population'] = +d['Population'];
                        d['Institutions'] = +d['1st_pillar_Institutions'];
                        d['Infrastructure'] = +d['2nd_pillar_Infrastructure'];
                        d['Macroeconomic Environment'] = +d['3rd_pillar_Macroeconomic_environment'];
                        d['Health and Primary Education'] = +d['4th_pillar_Health_and_primary_education'];
                        d['Higher Education and Training'] = +d['5th_pillar_Higher_education_and_training'];
                        d['Goods Market Efficiency'] = +d['6th_pillar_Goods_market_efficiency'];
                        d['Labor Market Efficiency'] = +d['7th_pillar_Labor_market_efficiency'];
                        d['Financial Market Development'] = +d['8th_pillar_Financial_market_development'];
                        d['Technological Readiness'] = +d['9th_pillar_Technological_readiness'];
                        d['Market Size'] = +d['10th_pillar_Market_size'];
                        d['Business Sophistication'] = +d['11th_pillar_Business_sophistication_'];
                        d['Innovation'] = +d['12th_pillar_Innovation'];
                    });	
					
					// Assign  the data object loaded to the global dataset variable
					dataset = data;

					// Generate the visualisation
					generateVis();

					// Iterate through our avilable years.
					setInterval(function() {
						display_year = display_year + 1;
						if(display_year > 2017){
							display_year = 2007;
						}
					  	generateVis();
					}, 2000);
				}
			});
        
    </script>
    
</body>	 
</html>


